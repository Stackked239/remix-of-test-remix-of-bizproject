# Netlify Configuration for BizHealth.ai
# Static Site Generation (SSG) with SPA fallback

# Redirect HTTP to HTTPS for www
[[redirects]]
  from = "http://www.bizhealth.ai/*"
  to = "https://bizhealth.ai/:splat"
  status = 301
  force = true

# Redirect HTTP to HTTPS for non-www
[[redirects]]
  from = "http://bizhealth.ai/*"
  to = "https://bizhealth.ai/:splat"
  status = 301
  force = true

# Redirect HTTPS www to non-www
[[redirects]]
  from = "https://www.bizhealth.ai/*"
  to = "https://bizhealth.ai/:splat"
  status = 301
  force = true

# Fix soft 404s - Redirect incorrect/old URLs to correct pages
[[redirects]]
  from = "/faq"
  to = "/faqs"
  status = 301
  force = true

[[redirects]]
  from = "/blog/e-commerce-scaling-smb-2025"
  to = "/blog/e-commerce-scaling-5-strategies-for-smbs-thriving-in-2025"
  status = 301
  force = true

[[redirects]]
  from = "/forgot-password"
  to = "/login"
  status = 301
  force = true

[[redirects]]
  from = "/refund"
  to = "/concerns"
  status = 301
  force = true

# Note: /security is a valid page - no redirect needed

# Fix noindex URL mismatches - Redirect hyphenated URLs to correct routes
[[redirects]]
  from = "/biz-tools"
  to = "/biztools"
  status = 301
  force = true

[[redirects]]
  from = "/biz-leader"
  to = "/bizleader"
  status = 301
  force = true

[[redirects]]
  from = "/blog/smb-financial-trends-2025"
  to = "/blog/2025-smb-financial-trends"
  status = 301
  force = true

[[redirects]]
  from = "/blog/strategic-planning"
  to = "/blog/strategic-planning-post-pandemic"
  status = 301
  force = true

[[redirects]]
  from = "/blog/talent-wars-hiring"
  to = "/blog/talent-wars-smb-hiring-2025"
  status = 301
  force = true

[[redirects]]
  from = "/blog/solving-smb-workforce-gaps"
  to = "/blog/solving-smb-workforce-gaps-2025"
  status = 301
  force = true

[[redirects]]
  from = "/blog/real-time-analytics-smb"
  to = "/blog/real-time-analytics-smb-agility"
  status = 301
  force = true

[[redirects]]
  from = "/biz-growth"
  to = "/bizgrowth"
  status = 301
  force = true

[[redirects]]
  from = "/biz-guides"
  to = "/bizguides"
  status = 301
  force = true

[[redirects]]
  from = "/bizgrowth-academy/vision-playbook"
  to = "/bizgrowth/vision-playbook"
  status = 301
  force = true

[[redirects]]
  from = "/privacy-policy"
  to = "/privacy"
  status = 301
  force = true

# Universal trailing slash removal - catches ALL paths ending with /
# This prevents future GSC redirect errors automatically
[[redirects]]
  from = "/*/"
  to = "/:splat"
  status = 301
  force = true

# Specific trailing slash redirects (kept for documentation/explicit handling)
[[redirects]]
  from = "/blog/chasing-sales-not-profits/"
  to = "/blog/chasing-sales-not-profits"
  status = 301
  force = true

[[redirects]]
  from = "/blog/business-health-scores-by-stage/"
  to = "/blog/business-health-scores-by-stage"
  status = 301
  force = true

[[redirects]]
  from = "/blog/emotional-intelligence-leadership-skill/"
  to = "/blog/emotional-intelligence-leadership-skill"
  status = 301
  force = true

[[redirects]]
  from = "/blog/lean-principles-small-business/"
  to = "/blog/lean-principles-small-business"
  status = 301
  force = true

[[redirects]]
  from = "/security/"
  to = "/security"
  status = 301
  force = true

[[redirects]]
  from = "/bizgrowth/growth/retail/p3-placement-planogram/"
  to = "/bizgrowth/growth/retail/p3-placement-planogram"
  status = 301
  force = true

[[redirects]]
  from = "/blog/planograms-transform-small-retail-operations/"
  to = "/blog/planograms-transform-small-retail-operations"
  status = 301
  force = true

[[redirects]]
  from = "/about/"
  to = "/about"
  status = 301
  force = true

[[redirects]]
  from = "/blog/growth-scaling/"
  to = "/blog/growth-scaling"
  status = 301
  force = true

[[redirects]]
  from = "/blog/fractional-cfo-toolkit/"
  to = "/blog/fractional-cfo-toolkit"
  status = 301
  force = true

[[redirects]]
  from = "/sherpas/"
  to = "/sherpas"
  status = 301
  force = true

[[redirects]]
  from = "/blog/r2a2-job-descriptions-role-clarity-small-business-teams/"
  to = "/blog/r2a2-job-descriptions-role-clarity-small-business-teams"
  status = 301
  force = true

[[redirects]]
  from = "/pricing/"
  to = "/pricing"
  status = 301
  force = true

[[redirects]]
  from = "/contact/"
  to = "/contact"
  status = 301
  force = true

[build]
  # Build command - runs SSG pre-rendering with Puppeteer support
  command = "chmod +x netlify-build.sh && ./netlify-build.sh"
  
  # Publish directory - contains pre-rendered HTML files
  publish = "dist"
  
  # Environment variables for build
  [build.environment]
    NODE_VERSION = "20"

# SPA fallback for client-side routing
# Serves index.html for routes that don't have pre-rendered files
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  force = false  # Only redirect if file doesn't exist
  
  # Don't redirect these file types (including downloadable files)
  conditions = {path = ["!/**/*.html", "!/**/*.js", "!/**/*.css", "!/**/*.png", "!/**/*.jpg", "!/**/*.jpeg", "!/**/*.gif", "!/**/*.svg", "!/**/*.webp", "!/**/*.ico", "!/**/*.json", "!/**/*.xml", "!/**/*.txt", "!/**/*.pdf", "!/**/*.docx", "!/**/*.xlsx", "!/**/*.doc", "!/**/*.xls", "!/**/*.zip"]}

# Security headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(self \"https://getcody.ai\" \"https://*.getcody.ai\"), camera=(self \"https://getcody.ai\" \"https://*.getcody.ai\"), autoplay=(self)"
    # Content Security Policy - allows Cody bot scripts, frames, and connections
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://trinketsofcody.com https://*.getcody.ai https://getcody.ai; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://trinketsofcody.com https://*.getcody.ai https://getcody.ai wss://*.getcody.ai; frame-src 'self' https://*.getcody.ai https://getcody.ai; frame-ancestors 'none';"

# Cache static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache images
[[headers]]
  for = "/*.jpg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.svg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Don't cache HTML (we want fresh content)
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# PDF files - proper MIME type and download headers
[[headers]]
  for = "/downloads/*.pdf"
  [headers.values]
    Content-Type = "application/pdf"
    Content-Disposition = "attachment"
    Cache-Control = "public, max-age=3600"

# DOCX files - proper MIME type and download headers
[[headers]]
  for = "/downloads/*.docx"
  [headers.values]
    Content-Type = "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    Content-Disposition = "attachment"
    Cache-Control = "public, max-age=3600"

# XLSX files - proper MIME type and download headers
[[headers]]
  for = "/downloads/*.xlsx"
  [headers.values]
    Content-Type = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    Content-Disposition = "attachment"
    Cache-Control = "public, max-age=3600"

# Prerender specific blog posts for better SEO
[[plugins]]
  package = "@netlify/plugin-lighthouse"
  
  [plugins.inputs]
    output_path = "lighthouse-reports"

# Function configuration (if using Netlify Functions)
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

# Dev server settings
[dev]
  command = "npm run dev"
  port = 8080
  targetPort = 8080
  autoLaunch = false
